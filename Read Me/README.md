# PowerLineApp - سیستم مدیریت خطوط برق

## 📋 فهرست مطالب
- [معرفی پروژه](#معرفی-پروژه)
- [ویژگی‌ها](#ویژگی‌ها)
- [ساختار پروژه](#ساختار-پروژه)
- [نحوه نصب و اجرا](#نحوه-نصب-و-اجرا)
- [راهنمای استفاده](#راهنمای-استفاده)
- [مشکلات حل شده](#مشکلات-حل-شده)
- [توسعه و نگهداری](#توسعه-و-نگهداری)

## 🏗️ معرفی پروژه

PowerLineApp یک نرم‌افزار مدیریت خطوط برق است که با PyQt5 و SQLite توسعه یافته است. این نرم‌افزار برای مدیریت اطلاعات خطوط برق، پرسنل و دکل‌ها طراحی شده است.

### زبان‌های برنامه‌نویسی و تکنولوژی‌ها
- **Python 3.x**
- **PyQt5** (رابط کاربری)
- **SQLite** (پایگاه داده)
- **Pandas** (پردازش داده‌ها)

## ✨ ویژگی‌ها

### 📊 مدیریت خطوط برق
- ثبت و ویرایش اطلاعات خطوط
- جستجو و فیلتر پیشرفته
- گزارش‌گیری Excel
- وارد کردن داده از Excel

### 👥 مدیریت پرسنل
- ثبت اطلاعات پرسنل
- مدیریت تیم‌ها
- گزارش‌گیری پرسنل
- وارد کردن از Excel

### 🗼 مدیریت دکل‌ها
- ثبت اطلاعات دکل‌ها
- مدیریت موقعیت جغرافیایی
- گزارش‌گیری دکل‌ها
- وارد کردن از Excel

### 🗺️ نقشه و موقعیت
- نمایش نقشه خطوط
- موقعیت‌یابی دکل‌ها
- مسیریابی

## 📁 ساختار پروژه

```
PowerLineApp/
├── main.py                 # فایل اصلی برنامه
├── database/
│   └── powerline.db       # پایگاه داده SQLite
├── ui/
│   ├── main_window.py     # پنجره اصلی
│   ├── lines_window.py    # مدیریت خطوط
│   ├── teams_window.py    # مدیریت پرسنل
│   ├── towers_window.py   # مدیریت دکل‌ها
│   └── map_window.py      # نمایش نقشه
├── widgets/
│   └── custom_widgets.py  # ویجت‌های سفارشی
├── utils/
│   └── database.py        # کلاس مدیریت دیتابیس
└── README.md              # این فایل
```

## 🚀 نحوه نصب و اجرا

### پیش‌نیازها
```bash
pip install PyQt5
pip install pandas
pip install openpyxl
```

### اجرای برنامه
```bash
python main.py
```

## 📖 راهنمای استفاده

### مدیریت خطوط برق
1. **افزودن خط جدید**: روی دکمه "افزودن" کلیک کنید
2. **ویرایش خط**: خط مورد نظر را انتخاب کرده و روی "ویرایش" کلیک کنید
3. **حذف خط**: خط(های) مورد نظر را انتخاب کرده و روی "حذف" کلیک کنید
4. **جستجو**: از فیلد جستجو در بالای جدول استفاده کنید
5. **گزارش**: روی دکمه "گزارش" کلیک کنید

### مدیریت پرسنل
1. **افزودن پرسنل**: روی دکمه "افزودن" کلیک کنید
2. **ویرایش پرسنل**: پرسنل مورد نظر را انتخاب کرده و روی "ویرایش" کلیک کنید
3. **حذف پرسنل**: پرسنل(های) مورد نظر را انتخاب کرده و روی "حذف" کلیک کنید
4. **جستجو**: از فیلد جستجو استفاده کنید
5. **گزارش**: روی دکمه "گزارش" کلیک کنید

### مدیریت دکل‌ها
1. **افزودن دکل**: روی دکمه "افزودن" کلیک کنید
2. **ویرایش دکل**: دکل مورد نظر را انتخاب کرده و روی "ویرایش" کلیک کنید
3. **حذف دکل**: دکل(های) مورد نظر را انتخاب کرده و روی "حذف" کلیک کنید
4. **جستجو**: از فیلد جستجو استفاده کنید
5. **گزارش**: روی دکمه "گزارش" کلیک کنید

### وارد کردن از Excel
1. فایل Excel را آماده کنید (ستون‌ها باید مطابق با ساختار برنامه باشد)
2. روی دکمه "وارد کردن" کلیک کنید
3. فایل Excel را انتخاب کنید
4. برنامه خطاها را بررسی کرده و گزارش می‌دهد

## 🔧 مشکلات حل شده

### مشکل کرش هنگام حذف چند ردیف
**مشکل**: برنامه هنگام حذف چند ردیف همزمان کرش می‌کرد.

**علت**: ترکیب مشکلات زیر:
1. **مشکل در CustomDialog_Flexible**: parent یا resource loading
2. **مشکل در Threading/Event Loop**: تداخل با QApplication.processEvents()
3. **مشکل در Resource Management**: آیکون‌ها یا style

**راه‌حل**:
1. **بهبود Error Handling**: اضافه کردن try/except های بیشتر
2. **Logging کامل**: برای debug مشکلات
3. **مدیریت بهتر Resource**: بستن امن dialog ها
4. **بهبود Timing**: تغییر ترتیب عملیات

**کد بهبود یافته**:
```python
def delete_line(self):
    logging.debug("[delete_line] Called")
    try:
        # جمع‌آوری کدهای خطوط
        line_codes_to_delete = []
        for row in selected_rows:
            try:
                line_code = self.table.item(row, 0).text()
                if line_code:
                    line_codes_to_delete.append(line_code)
            except Exception as e:
                logging.error(f"Error reading line_code: {str(e)}")
                continue
        
        # حذف از دیتابیس
        for line_code in line_codes_to_delete:
            try:
                self.db.execute_query("DELETE FROM lines WHERE Line_Code=?", (line_code,))
            except Exception as e:
                logging.error(f"Error deleting line {line_code}: {str(e)}")
                continue
                
        # نمایش نتیجه
        dlg = CustomDialog_Flexible(header_text="موفقیت", main_text=f"{deleted_count} خط حذف شد.")
        dlg.exec_()
    except Exception as e:
        logging.error(f"Error in delete_line: {str(e)}")
        QMessageBox.critical(self, "خطا", f"خطا در حذف: {str(e)}")
```

### مشکل دیالوگ‌های خطا
**مشکل**: دیالوگ‌های خطا متن طولانی داشتند و scrollbar نمایش داده نمی‌شد.

**راه‌حل**: بهبود CustomDialog_Flexible برای محاسبه ارتفاع متن و نمایش scrollbar.

### مشکل حذف چند ردیف
**مشکل**: هنگام حذف چند ردیف، index ها تغییر می‌کردند و خطا رخ می‌داد.

**راه‌حل**: ابتدا تمام شناسه‌ها را جمع‌آوری کرده، سپس حذف می‌کنیم.

## 🛠️ توسعه و نگهداری

### اضافه کردن ویژگی جدید
1. فایل مربوطه را در پوشه `ui/` ایجاد کنید
2. کلاس جدید را از `QWidget` ارث‌بری کنید
3. در `main_window.py` آن را اضافه کنید
4. دیتابیس را در صورت نیاز به‌روزرسانی کنید

### بهبود عملکرد
- از **logging** برای debug استفاده کنید
- **try/except** برای تمام عملیات حساس اضافه کنید
- **Resource management** را رعایت کنید
- **Native widgets** را برای عملیات حساس ترجیح دهید

### نکات مهم توسعه
1. **همیشه از logging استفاده کنید**
2. **Exception handling کامل داشته باشید**
3. **Resource ها را درست مدیریت کنید**
4. **Timing عملیات را در نظر بگیرید**
5. **User experience را اولویت دهید**

## 🎨 نکات فنی UI/UX

### QComboBox راست‌چین در PyQt5
**مشکل**: اگر در QSS مربوط به QComboBox پراپرتی padding قرار دهید، متن کمبو حتی اگر layoutDirection یا text-align روی راست‌چین باشد، به صورت چپ‌چین نمایش داده می‌شود.

**راه‌حل**: برای کمبوهای راست‌چین نباید از padding در QComboBox استفاده کرد. برای زیباسازی و بزرگ‌تر کردن کمبو باید از پراپرتی‌هایی مثل min-height، font-size، border-radius و margin استفاده شود و padding را حذف کنید.

### دیالوگ با گوشه‌های پخ واقعی
**مشکل**: اگر فقط به QDialog یا QFrame پخ (border-radius) بدهید اما پس‌زمینه QDialog شفاف نباشد، گوشه‌های مربع زیرین دیده می‌شود.

**راه‌حل تضمینی**:
1. QDialog باید background: transparent و border: none داشته باشد
2. Qt.WA_TranslucentBackground را روی QDialog فعال کنید
3. یک QFrame با background: white و border-radius به عنوان container اصلی قرار دهید
4. setContentsMargins برای QDialog باید صفر باشد

### بهبود عملکرد فیلترها
**مشکل قبلی**: فیلترها به صورت Real-time عمل می‌کردند که باعث کندی در تایپ می‌شد.

**راه‌حل**: استفاده از دکمه جستجو به جای جستجوی خودکار
```python
def perform_search(self):
    """انجام جستجو با کلیک روی دکمه"""
    search_text = self.filter_input.text().strip()
    self.load_table(search_text)

def clear_search(self):
    """پاک کردن فیلتر و نمایش همه نتایج"""
    self.filter_input.clear()
    self.load_table("")
```

### مدیریت Progress Dialog
**مشکل**: تایمر در progress dialog به درستی کار نمی‌کرد.

**راه‌حل**:
1. به جای چک کردن dlg.result()، از یک فلگ داخلی استفاده کنید
2. سیگنال cancel دکمه لغو را به یک اسلات وصل کنید و تایمر را متوقف کنید
3. دیالوگ را با show() نمایش دهید و فقط زمانی که شمارش تمام شد یا کاربر لغو کرد، آن را ببندید

## 📝 تغییرات اخیر

### نسخه 9.99
- ✅ رفع مشکل کرش هنگام حذف چند ردیف
- ✅ بهبود CustomDialog_Flexible
- ✅ اضافه کردن logging کامل
- ✅ بهبود error handling
- ✅ بهینه‌سازی عملکرد

## 🤝 مشارکت

برای مشارکت در توسعه این پروژه:
1. Fork کنید
2. Branch جدید ایجاد کنید
3. تغییرات را commit کنید
4. Pull Request ارسال کنید

## 📄 لایسنس

این پروژه تحت لایسنس MIT منتشر شده است.

---

**توسعه‌دهنده**: تیم توسعه PowerLineApp  
**آخرین به‌روزرسانی**: 2025-07-13  
**نسخه**: 9.99 